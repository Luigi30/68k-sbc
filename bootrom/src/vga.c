#include "vga.h"

#define ISA_CGA_IOBASE 0xFA0000
#define ISA_CGA_MEMBASE 0x800000
#define MEM_TO_68K(address) ( (ISA_CGA_MEMBASE+1) * (2 + (address)) )
#define IO_TO_68K(address) (2+address * 0xFA0000)

/* TODO: move to vga.c */
void VGA_SetControllerRegister(uint16_t address_reg, uint16_t data_reg, uint8_t attrindex, uint8_t data)
{
  uint8_t tempaddr = MMIO8(IO_TO_68K(address_reg));
  MMIO16(IO_TO_68K(address_reg)) = attrindex;
  MMIO16(IO_TO_68K(data_reg)) = data;
  MMIO16(IO_TO_68K(address_reg)) = tempaddr;
}

void VGA_SetDMAColor(uint8_t r, uint8_t g, uint8_t b)
{
  MMIO16(0xFA0000 + (0x3C9*2)) = r;
  MMIO16(0xFA0000 + (0x3C9*2)) = g;
  MMIO16(0xFA0000 + (0x3C9*2)) = b;
}

void VGA_SetBitplaneWriteMask(uint8_t bitplanes)
{
  //0x01 = plane 0
  //0x02 = plane 1
  //0x04 = plane 2
  //0x08 = plane 3

  MMIO16(0xFA0000 + (0x3C4*2)) = 0x02;
  MMIO16(0xFA0000 + (0x3C5*2)) = bitplanes;
}

void VGA_Set80x25Mode()
{
  // Set VGA to 80x25
  MMIO16(0xFA0000 + (2*0x3C2)) = 0x67;
  
  int temp;
  temp = MMIO16(0xFA0000 + (2*0x3D0)); // reset to index mode
  
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x10; // index
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x0C; // data

  MMIO16(0xFA0000 + (2*0x3C0)) = 0x11;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x00;
  
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x12;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x0F;

  MMIO16(0xFA0000 + (2*0x3C0)) = 0x13;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x08;

  MMIO16(0xFA0000 + (2*0x3C0)) = 0x14;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x00;
  //
  MMIO16(0xFA0000 + (2*0x3C4)) = 0x01;
  MMIO16(0xFA0000 + (2*0x3C5)) = 0x00;

  MMIO16(0xFA0000 + (2*0x3C4)) = 0x03;
  MMIO16(0xFA0000 + (2*0x3C5)) = 0x00;

  MMIO16(0xFA0000 + (2*0x3C4)) = 0x04;
  MMIO16(0xFA0000 + (2*0x3C5)) = 0x07;

  MMIO16(0xFA0000 + (2*0x3CE)) = 0x05;
  MMIO16(0xFA0000 + (2*0x3CF)) = 0x10;

  MMIO16(0xFA0000 + (2*0x3CE)) = 0x06;
  MMIO16(0xFA0000 + (2*0x3CF)) = 0x0E;
  //
  MMIO16(0xFA0000 + (2*0x3D4)) = 0x00;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x5F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x01;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x4F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x02;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x50;
  
  MMIO16(0xFA0000 + (2*0x3D4)) = 0x03;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x82;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x04;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x55;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x05;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x81;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x06;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0xBF;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x07;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x1F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x08;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x00;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x09;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x4F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x10;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x9C;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x11;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x8E;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x12;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x8F;
  
  MMIO16(0xFA0000 + (2*0x3D4)) = 0x13;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x28;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x14;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x1F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x15;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x96;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x16;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0xB9;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x17;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0xA3;
}

void VGA_SetMode13h()
{
  // Set VGA to 80x25
  MMIO16(0xFA0000 + (2*0x3C2)) = 0x63;
  
  int temp;
  temp = MMIO16(0xFA0000 + (2*0x3D0)); // reset to index mode
  
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x10; // index
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x41; // data

  MMIO16(0xFA0000 + (2*0x3C0)) = 0x11;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x00;
  
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x12;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x0F;

  MMIO16(0xFA0000 + (2*0x3C0)) = 0x13;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x00;

  MMIO16(0xFA0000 + (2*0x3C0)) = 0x14;
  MMIO16(0xFA0000 + (2*0x3C0)) = 0x00;
  //
  MMIO16(0xFA0000 + (2*0x3C4)) = 0x01;
  MMIO16(0xFA0000 + (2*0x3C5)) = 0x01;

  MMIO16(0xFA0000 + (2*0x3C4)) = 0x03;
  MMIO16(0xFA0000 + (2*0x3C5)) = 0x00;

  MMIO16(0xFA0000 + (2*0x3C4)) = 0x04;
  MMIO16(0xFA0000 + (2*0x3C5)) = 0x0E;

  MMIO16(0xFA0000 + (2*0x3CE)) = 0x05;
  MMIO16(0xFA0000 + (2*0x3CF)) = 0x40;

  MMIO16(0xFA0000 + (2*0x3CE)) = 0x06;
  MMIO16(0xFA0000 + (2*0x3CF)) = 0x05;
  //
  MMIO16(0xFA0000 + (2*0x3D4)) = 0x00;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x5F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x01;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x4F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x02;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x50;
  
  MMIO16(0xFA0000 + (2*0x3D4)) = 0x03;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x82;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x04;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x54;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x05;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x80;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x06;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0xBF;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x07;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x1F;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x08;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x00;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x09;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x41;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x10;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x9C;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x11;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x8E;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x12;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x8F;
  
  MMIO16(0xFA0000 + (2*0x3D4)) = 0x13;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x28;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x14;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x40;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x15;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0x96;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x16;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0xB9;

  MMIO16(0xFA0000 + (2*0x3D4)) = 0x17;
  MMIO16(0xFA0000 + (2*0x3D5)) = 0xA3;
}

void VGA_SetMode13Pixel(uint16_t x, uint16_t y, uint8_t color)
{
  //Calculate the pixel offset.
  uint32_t offset = (y*320) + x;
  MMIO16(0x800000 + 2*(0xA0000 + offset)) = color;
}

void VGA_SetStandardPalette()
{
  MMIO16(0xFA0000 + (0x3C8*2)) = 0x00;

  //Each call to VGA_SetDMAColor advances the DMA pointer.

  // Standard VGA text colors.
  VGA_SetDMAColor(0, 0, 0);
  VGA_SetDMAColor(0, 0, 42);
  VGA_SetDMAColor(0, 42, 0);
  VGA_SetDMAColor(0, 42, 42);
  VGA_SetDMAColor(42, 0, 0);
  VGA_SetDMAColor(42, 0, 42);
  VGA_SetDMAColor(42, 21, 0);
  VGA_SetDMAColor(0, 42, 42);

  VGA_SetDMAColor(21, 21, 21);
  VGA_SetDMAColor(21, 21, 63);
  VGA_SetDMAColor(21, 63, 21);
  VGA_SetDMAColor(21, 63, 63);
  VGA_SetDMAColor(63, 21, 21);
  VGA_SetDMAColor(63, 21, 63);
  VGA_SetDMAColor(63, 63, 21);
  VGA_SetDMAColor(63, 63, 63);
  
  // Set 16 text palette entries.
  for(int i=0; i<16; i++)
	{
	  MMIO16(0xFA0000 + (0x3C0*2)) = i;
	  MMIO16(0xFA0000 + (0x3C0*2)) = i;
	}

  // Re-enable the palette.
  MMIO16(0xFA0000 + (0x3C0*2)) = 0x20;
}
